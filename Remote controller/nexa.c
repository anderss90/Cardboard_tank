


#include "common_variables.h"
#include <avr/io.h>
#include <util/delay.h>
#include "nexa.h"


#define NEXA_TX_PORT       PORTD
#define NEXA_TX_DDR        DDRD
#define NEXA_TX_PIN        PD1

#define NEXA_TX_RETRIES    1
#define NEXA_MSG_SIZE      12
#define NEXA_MSG_SIZE_32   32

#define NEXA_HIGH          (NEXA_TX_PORT |=  (1 << NEXA_TX_PIN))
#define NEXA_LOW           (NEXA_TX_PORT &= ~(1 << NEXA_TX_PIN))

#define NEXA_SHORT_DELAY  _delay_ms(0.35)
#define NEXA_LONG_DELAY  _delay_ms(1.2)
#define NEXA_PULSE_DELAY  _delay_ms(0.25)
	
// 32 bit id=3 cmd=off
char NEXA_BLINDS_DOWN[NEXA_MSG_SIZE_32]  = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01};
char NEXA_BLINDS_UP[NEXA_MSG_SIZE_32]  = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01};
	
char NEXA_1_ON[NEXA_MSG_SIZE_32]  = {0x00,0x00,0x01,0x00,0x01,0x01,0x01,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x01,0x00,0x00,0x00,0x00};
char NEXA_1_OFF[NEXA_MSG_SIZE_32]  = {0x00,0x00,0x01,0x00,0x01,0x01,0x01,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
	
char NEXA_2_ON[NEXA_MSG_SIZE_32]  = {0x00,0x00,0x01,0x00,0x01,0x01,0x01,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x01,0x00,0x00,0x00,0x01};
char NEXA_2_OFF[NEXA_MSG_SIZE_32]  = {0x00,0x00,0x01,0x00,0x01,0x01,0x01,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x01};
	
char NEXA_3_ON[NEXA_MSG_SIZE_32]  = {0x00,0x00,0x01,0x00,0x01,0x01,0x01,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x01,0x00,0x00,0x01,0x00};
char NEXA_3_OFF[NEXA_MSG_SIZE_32]  = {0x00,0x00,0x01,0x00,0x01,0x01,0x01,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0x00};
//12 bit attempt on blinds
char NEXA_BLINDS_DOWN_12[NEXA_MSG_SIZE]  = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00};




void nexa_pulse(){
	NEXA_HIGH;
	NEXA_PULSE_DELAY;
	NEXA_LOW;
}
void nexa_init_pulse(){
	nexa_pulse();
	_delay_ms(2.7);
}
void nexa_init()
{
    NEXA_TX_DDR |= (1 << NEXA_TX_PIN);
}


void nexa_1_on(){
	nexa_send_cmd(NEXA_1_ON,NEXA_MSG_SIZE_32);
}
void nexa_1_off(){
	nexa_send_cmd(NEXA_1_OFF,NEXA_MSG_SIZE_32);
}
void nexa_2_on(){
	nexa_send_cmd(NEXA_2_ON,NEXA_MSG_SIZE_32);
}
void nexa_2_off(){
	nexa_send_cmd(NEXA_2_OFF,NEXA_MSG_SIZE_32);
}
void nexa_3_on(){
	nexa_send_cmd(NEXA_3_ON,NEXA_MSG_SIZE_32);
}
void nexa_3_off(){
	nexa_send_cmd(NEXA_3_OFF,NEXA_MSG_SIZE_32);
}



void nexa_send_cmd(char* cmd, uint8_t msg_size)
{
    for (unsigned char i = 0; i < NEXA_TX_RETRIES; ++i)
    {
        for (unsigned char j = 0; j < 4; ++j)
        {
			nexa_init_pulse();
            // NEXA data
            for (unsigned char k = 0; k < msg_size; ++k)
            {
                if (cmd[k] == 0x00)
                {
                    nexa_pulse();
					
					NEXA_SHORT_DELAY;
					
					nexa_pulse();
					
					NEXA_LONG_DELAY;
                }
                else
                {
					nexa_pulse();
					
					NEXA_LONG_DELAY;
					
					nexa_pulse();
					
					NEXA_SHORT_DELAY;
                }
            }

            // NEXA stop pattern
			
           nexa_pulse();
			
            for(unsigned char l = 0; l < 32; ++l)
            {
                NEXA_SHORT_DELAY;
            }
        }
    }
	NEXA_LOW;
}
